#!/usr/bin/env python

import sys
import re

def catch(func):
    try:
        return func()
    except Exception, e:
        print >> sys.stderr, str(e)
    return None

def main():
    pre, body, post = '', '', ''
    if len(sys.argv) == 2:
        body = sys.argv[1]
    elif len(sys.argv) == 4:
        pre, body, post = sys.argv[1], sys.argv[2], sys.argv[3]
    else:
        print >> sys.stderr, 'usage:'
        print >> sys.stderr, '    %s PRE BODY POST' % (sys.argv[0],)
        print >> sys.stderr, '    %s BODY' % (sys.argv[0],)
        sys.exit(1)

    exec(pre)
    for line in sys.stdin:
        line = line.strip('\n')
        try:
            exec(body)
        except Exception, e:
            print >> sys.stderr, str(e)
    exec(post)

if __name__ == '__main__':
    main()
